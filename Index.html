<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doodle Art AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background: linear-gradient(to bottom right, #f3e8ff, #fff3f9, #fefce8);
            position: relative;
            overflow: hidden;
        }

        /* Decorative background elements */
        body::before, body::after {
            content: '';
            position: absolute;
            z-index: -1;
            filter: blur(80px);
            border-radius: 50%;
            opacity: 0.6;
            animation: pulse 10s infinite ease-in-out;
        }

        body::before {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #805ad5, #e9d8fd);
            top: -100px;
            left: -100px;
        }

        body::after {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #f687b3, #fee2e2);
            bottom: -100px;
            right: -100px;
            animation-delay: 2s;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0.6; }
        }

        #generateBtn {
            background: linear-gradient(to right, #6b46c1, #805ad5);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #generateBtn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .container-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            text-align: center;
        }

        #editorCanvas {
            border: 2px solid #e2e8f0;
            cursor: crosshair;
        }
    </style>
</head>
<body class="p-4 min-h-screen flex items-center justify-center">

    <!-- Main Container -->
    <div class="w-full max-w-4xl p-8 bg-white rounded-3xl container-shadow flex flex-col items-center">
        <h1 class="text-5xl font-extrabold text-gray-900 mb-1 text-center">Doodle Art AI</h1>
        <h2 class="text-2xl font-semibold text-purple-700 mb-2 text-center">AI Image Generator</h2>
        <p class="text-gray-600 text-center mb-8">Create amazing art with just a text prompt!</p>

        <!-- Auth Section -->
        <div id="authContainer" class="w-full flex flex-col items-center space-y-4 mb-6 hidden">
            <h3 class="text-2xl font-semibold text-gray-800" id="authTitle">Register Account</h3>
            <input id="emailInput" type="email" placeholder="Email" class="w-full max-w-sm p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-300 transition-shadow">
            <input id="passwordInput" type="password" placeholder="Password" class="w-full max-w-sm p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-300 transition-shadow">
            <button id="authBtn" class="w-full max-w-sm px-6 py-3 bg-purple-600 text-white font-medium rounded-xl hover:bg-purple-700 transition-colors shadow-lg">Register</button>
            <p id="authMessage" class="text-red-500 hidden"></p>
            <button id="toggleAuthBtn" class="text-purple-500 text-sm hover:underline">Already have an account? Sign in</button>
            <button id="guestBtn" class="w-full max-w-sm px-6 py-3 bg-gray-200 text-gray-800 font-medium rounded-xl hover:bg-gray-300 transition-colors shadow-lg">Continue as Guest</button>
        </div>

        <!-- App Section -->
        <div id="appContainer" class="w-full flex flex-col items-center hidden">
            <div class="w-full flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <span id="userStatus" class="text-sm font-medium text-gray-600"></span>
                    <span id="goPremiumText" class="text-purple-500 text-sm hover:underline ml-2 hidden">Go Premium and get unlimited AI Prompts</span>
                </div>
                <button id="signOutBtn" class="text-sm text-red-500 hover:underline hidden">Sign Out</button>
                <button id="backToLoginBtn" class="text-sm text-purple-500 hover:underline hidden">Back to Login</button>
            </div>
            
            <!-- Main AI Generation View -->
            <div id="generationSection" class="w-full flex flex-col items-center">
                <!-- Generation Controls Container -->
                <div id="generationControlsContainer" class="w-full">
                    <!-- Prompt Input -->
                    <div class="w-full mb-6">
                        <textarea id="promptInput" class="w-full h-32 p-4 text-gray-700 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-300 transition-shadow" placeholder="Describe the image you want to generate (e.g., 'A futuristic city at sunset, digital painting')"></textarea>
                    </div>
        
                    <!-- Generate Button and Loading Indicator -->
                    <button id="generateBtn" class="w-full px-8 py-3 font-bold text-white rounded-full shadow-lg">
                        Generate Image
                    </button>
                </div>
                
                <!-- Payment Plans Section (hidden by default) -->
                <div id="paymentPlansContainer" class="w-full flex flex-col items-center space-y-6 hidden">
                    <h3 class="text-3xl font-bold text-gray-800 text-center">You've reached your limit.</h3>
                    <p class="text-gray-600 text-center">Get a subscription to continue creating amazing art!</p>
                    <div class="flex flex-col md:flex-row w-full max-w-xl space-y-4 md:space-y-0 md:space-x-6">
                        <!-- Starter Plan -->
                        <div class="flex-1 p-6 bg-purple-200 text-purple-800 rounded-2xl border-2 border-purple-200 shadow-md text-center hover:shadow-xl transition-shadow">
                            <h4 class="text-2xl font-semibold mb-2">Starter Plan</h4>
                            <p class="text-4xl font-bold mb-2">$2.99</p>
                            <p class="mb-4">50 Prompts</p>
                            <button id="starterPlanBtn" data-prompts="50" class="w-full px-6 py-3 bg-purple-600 text-white font-medium rounded-xl hover:bg-purple-700 transition-colors shadow-lg">Purchase</button>
                        </div>
                        <!-- Unlimited Plan -->
                        <div class="flex-1 p-6 bg-purple-600 text-white rounded-2xl border-2 border-purple-600 shadow-md text-center hover:shadow-xl transition-shadow">
                            <h4 class="text-2xl font-semibold mb-2">Unlimited Plan</h4>
                            <p class="text-4xl font-bold mb-2">$8.99</p>
                            <p class="mb-4">Unlimited Prompts</p>
                            <button id="unlimitedPlanBtn" data-prompts="-1" class="w-full px-6 py-3 bg-white text-purple-600 font-medium rounded-xl hover:bg-gray-200 transition-colors shadow-lg">Purchase</button>
                        </div>
                    </div>
                </div>
                
                <!-- Loading spinner -->
                <div id="loadingSpinner" class="hidden mt-4 flex items-center justify-center text-purple-600">
                    <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating...
                </div>
    
                <!-- Error Message -->
                <div id="errorMessage" class="hidden mt-4 text-red-600 font-medium text-center"></div>
    
                <!-- Generated Image Display -->
                <div id="generatedImageContainer" class="hidden mt-8 w-full">
                    <h3 class="text-2xl font-semibold text-gray-800 text-center mb-4">Your AI-Generated Art</h3>
                    <div class="flex justify-center items-center p-2 bg-gray-50 rounded-lg shadow-inner">
                        <img id="generatedImage" alt="Generated AI Art" class="max-w-full h-auto rounded-xl">
                    </div>
                </div>

                <!-- Go to Editor Button -->
                <button id="goToEditorBtn" class="mt-8 px-6 py-3 bg-gray-200 text-gray-800 font-medium rounded-xl hover:bg-gray-300 transition-colors shadow-lg">Go to Image Editor</button>
            </div>

            <!-- Image Editor View -->
            <div id="editorSection" class="w-full flex flex-col items-center hidden">
                <h3 class="text-2xl font-semibold text-gray-800 text-center mb-4">Edit Your Image</h3>
                
                <!-- File Upload & Go Back Buttons -->
                <div class="w-full flex flex-col md:flex-row items-center justify-between mb-4 space-y-2 md:space-y-0 md:space-x-4">
                    <label for="imageUpload" class="px-6 py-3 bg-purple-600 text-white font-medium rounded-xl hover:bg-purple-700 transition-colors shadow-lg cursor-pointer">
                        Upload Image
                    </label>
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                    <button id="backToGeneratorBtn" class="px-6 py-3 bg-gray-200 text-gray-800 font-medium rounded-xl hover:bg-gray-300 transition-colors shadow-lg">Back to Generator</button>
                </div>

                <!-- Canvas & Tool Controls -->
                <div class="w-full flex flex-col items-center space-y-4">
                    <div class="w-full flex justify-center space-x-2">
                        <button id="paintToolBtn" class="p-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">Paint</button>
                        <button id="eraseToolBtn" class="p-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">Erase</button>
                        <button id="clearCanvasBtn" class="p-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">Clear</button>
                    </div>
                    <canvas id="editorCanvas" class="w-full h-auto max-w-full"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- Guest Prompt Modal -->
    <div id="guestPromptModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Create an Account to Continue</h3>
            <p class="text-gray-600 mb-6">You've used all 10 of your free prompts. Sign up to get unlimited access and save your art!</p>
            <div class="flex justify-center space-x-4">
                <button id="createAccountBtn" class="px-6 py-3 bg-purple-600 text-white font-medium rounded-xl hover:bg-purple-700 transition-colors shadow-lg">Create Account</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            onAuthStateChanged, 
            signInAnonymously, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            collection 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase, provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth State Management ---
        let app, db, auth;
        let userId;

        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authBtn = document.getElementById('authBtn');
        const toggleAuthBtn = document.getElementById('toggleAuthBtn');
        const authMessage = document.getElementById('authMessage');
        const authTitle = document.getElementById('authTitle');
        const signOutBtn = document.getElementById('signOutBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const userStatus = document.getElementById('userStatus');
        const guestBtn = document.getElementById('guestBtn');
        const goPremiumText = document.getElementById('goPremiumText');

        const generationSection = document.getElementById('generationSection');
        const editorSection = document.getElementById('editorSection');

        const generationControlsContainer = document.getElementById('generationControlsContainer');
        const paymentPlansContainer = document.getElementById('paymentPlansContainer');
        const starterPlanBtn = document.getElementById('starterPlanBtn');
        const unlimitedPlanBtn = document.getElementById('unlimitedPlanBtn');
        const guestPromptModal = document.getElementById('guestPromptModal');
        const createAccountBtn = document.getElementById('createAccountBtn');
        const goToEditorBtn = document.getElementById('goToEditorBtn');
        const backToGeneratorBtn = document.getElementById('backToGeneratorBtn');

        let isSigningIn = false;

        window.onload = async () => {
            try {
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await ensureUserDocument(user.uid);
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        updateUserStatus(user);
                    } else {
                        userId = null;
                        authContainer.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                        updateUserStatus(null);
                    }
                });
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Firebase init or auth error:", err);
            }
        };

        const ensureUserDocument = async (uid) => {
            if (!uid) return;
            const userDocRef = doc(collection(db, `artifacts/${appId}/users/${uid}/data/`), 'usage');
            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                await setDoc(userDocRef, { 
                    remainingPrompts: 10,
                    signedUp: false
                });
            }
        };

        const updateUserStatus = async (user) => {
            if (!user) {
                userStatus.textContent = "Guest Mode | Prompts: 10";
                signOutBtn.classList.add('hidden');
                backToLoginBtn.classList.add('hidden');
                goPremiumText.classList.remove('hidden');
                return;
            }

            const userDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/data/`), 'usage');
            const docSnap = await getDoc(userDocRef);
            
            if (!docSnap.exists()) {
                userStatus.textContent = "Guest Mode | Prompts: 10";
                signOutBtn.classList.add('hidden');
                backToLoginBtn.classList.remove('hidden');
                goPremiumText.classList.remove('hidden');
                return;
            }

            const data = docSnap.data();
            const remaining = data.remainingPrompts;
            let userType;

            if (user.isAnonymous) {
                userType = "Guest Mode";
                signOutBtn.classList.add('hidden');
                backToLoginBtn.classList.remove('hidden');
                goPremiumText.classList.remove('hidden');
            } else {
                userType = "Welcome";
                signOutBtn.classList.remove('hidden');
                backToLoginBtn.classList.add('hidden');
                goPremiumText.classList.add('hidden');
            }

            userStatus.textContent = `${userType} | Prompts: ${remaining === -1 ? 'Unlimited' : remaining}`;
            
            if (remaining === 0) {
                if (user.isAnonymous) {
                    guestPromptModal.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                } else {
                    showPaymentPlans();
                }
            } else {
                showGenerationInterface();
            }
        };

        const showPaymentPlans = () => {
            generationControlsContainer.classList.add('hidden');
            paymentPlansContainer.classList.remove('hidden');
        };

        const showGenerationInterface = () => {
            generationControlsContainer.classList.remove('hidden');
            paymentPlansContainer.classList.add('hidden');
        };

        const showEditor = () => {
            generationSection.classList.add('hidden');
            editorSection.classList.remove('hidden');
        };

        const showGenerator = () => {
            editorSection.classList.add('hidden');
            generationSection.classList.remove('hidden');
        };

        authBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                authMessage.textContent = "Please enter both email and password.";
                authMessage.classList.remove('hidden');
                return;
            }

            try {
                authMessage.classList.add('hidden');
                if (isSigningIn) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const uid = userCredential.user.uid;
                    const userDocRef = doc(collection(db, `artifacts/${appId}/users/${uid}/data/`), 'usage');
                    const docSnap = await getDoc(userDocRef);
                    if (!docSnap.exists() || !docSnap.data().signedUp) {
                        await updateDoc(userDocRef, {
                            remainingPrompts: 10,
                            signedUp: true
                        });
                    }
                }
            } catch (error) {
                authMessage.textContent = `Auth Error: ${error.message}`;
                authMessage.classList.remove('hidden');
            }
        });

        toggleAuthBtn.addEventListener('click', () => {
            isSigningIn = !isSigningIn;
            if (isSigningIn) {
                authTitle.textContent = "Sign In";
                authBtn.textContent = "Sign In";
                toggleAuthBtn.textContent = "Don't have an account? Register";
                guestBtn.classList.add('hidden');
            } else {
                authTitle.textContent = "Register Account";
                authBtn.textContent = "Register";
                toggleAuthBtn.textContent = "Already have an account? Sign in";
                guestBtn.classList.remove('hidden');
            }
        });

        guestBtn.addEventListener('click', async () => {
            await signInAnonymously(auth);
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error:", error);
            }
        });

        backToLoginBtn.addEventListener('click', async () => {
            try {
                await signOut(auth); // Sign out the anonymous user
            } catch (error) {
                console.error("Sign out error:", error);
            }
        });

        createAccountBtn.addEventListener('click', () => {
            guestPromptModal.classList.add('hidden');
            authContainer.classList.remove('hidden');
            authTitle.textContent = "Create an Account";
            authBtn.textContent = "Register";
            toggleAuthBtn.textContent = "Already have an account? Sign in";
            guestBtn.classList.add('hidden');
        });

        const handlePurchasePlan = async (promptsToAdd) => {
            if (!userId) {
                return;
            }

            const userDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/data/`), 'usage');
            const docSnap = await getDoc(userDocRef);
            const currentPrompts = docSnap.data().remainingPrompts || 0;
            let newPrompts = currentPrompts;

            if (promptsToAdd === -1) {
                newPrompts = -1;
            } else if (currentPrompts === -1) {
                newPrompts = -1;
            } else {
                newPrompts += promptsToAdd;
            }

            await updateDoc(userDocRef, { remainingPrompts: newPrompts });
            await updateUserStatus(auth.currentUser);
            displayMessage("Purchase successful! Your prompts have been updated.", false);
        };

        starterPlanBtn.addEventListener('click', () => handlePurchasePlan(parseInt(starterPlanBtn.dataset.prompts)));
        unlimitedPlanBtn.addEventListener('click', () => handlePurchasePlan(parseInt(unlimitedPlanBtn.dataset.prompts)));
        goPremiumText.addEventListener('click', showPaymentPlans);
        goToEditorBtn.addEventListener('click', showEditor);
        backToGeneratorBtn.addEventListener('click', showGenerator);

        // --- UI Interaction and API Call ---
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessageDiv = document.getElementById('errorMessage');
        const generatedImageContainer = document.getElementById('generatedImageContainer');
        const generatedImageEl = document.getElementById('generatedImage');

        generateBtn.addEventListener('click', async () => {
            if (!userId) {
                displayMessage("Please sign in to generate art.", true);
                return;
            }

            const prompt = promptInput.value.trim();
            if (!prompt) {
                displayMessage("Please enter a text prompt to generate an image.", true);
                return;
            }

            const userDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/data/`), 'usage');
            const userDoc = await getDoc(userDocRef);
            const remainingPrompts = userDoc.data()?.remainingPrompts || 0;

            if (remainingPrompts === 0) {
                displayMessage("You have no prompts remaining. Please subscribe to continue.", true);
                if (auth.currentUser.isAnonymous) {
                    guestPromptModal.classList.remove('hidden');
                } else {
                    showPaymentPlans();
                }
                return;
            }

            showLoading(true);
            displayMessage("", false); 
            generatedImageContainer.classList.add('hidden');

            const makeApiCall = async (retryCount = 0) => {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                const payload = {
                    instances: {
                        prompt: prompt
                    },
                    parameters: { "sampleCount": 1 }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < 5) {
                            const delay = Math.pow(2, retryCount) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return makeApiCall(retryCount + 1);
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        generatedImageEl.src = imageUrl;
                        generatedImageContainer.classList.remove('hidden');

                        if (remainingPrompts !== -1) {
                            await updateDoc(userDocRef, {
                                remainingPrompts: remainingPrompts - 1
                            });
                        }
                        await updateUserStatus(auth.currentUser);
                    } else {
                        displayMessage("Failed to generate image. Please try again.", true);
                    }
                } catch (err) {
                    console.error("Error generating image:", err);
                    displayMessage("An error occurred. Please check your network connection and try again.", true);
                } finally {
                    showLoading(false);
                }
            };
            makeApiCall();
        });

        function showLoading(show) {
            if (show) {
                generateBtn.disabled = true;
                generateBtn.classList.add('cursor-not-allowed', 'opacity-75');
                generateBtn.style.background = 'linear-gradient(to right, #9f7aea, #b794f4)';
                loadingSpinner.classList.remove('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('cursor-not-allowed', 'opacity-75');
                generateBtn.style.background = 'linear-gradient(to right, #6b46c1, #805ad5)';
                loadingSpinner.classList.add('hidden');
            }
        }

        function displayMessage(message, isError) {
            errorMessageDiv.textContent = message;
            if (isError) {
                errorMessageDiv.classList.remove('hidden');
            } else {
                errorMessageDiv.classList.add('hidden');
            }
        }

        // --- Image Editor Logic ---
        const imageUpload = document.getElementById('imageUpload');
        const editorCanvas = document.getElementById('editorCanvas');
        const clearCanvasBtn = document.getElementById('clearCanvasBtn');
        const paintToolBtn = document.getElementById('paintToolBtn');
        const eraseToolBtn = document.getElementById('eraseToolBtn');
        const ctx = editorCanvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentTool = 'paint';

        // Set initial canvas size
        const resizeCanvas = () => {
            const container = editorCanvas.parentElement;
            editorCanvas.width = container.clientWidth;
            editorCanvas.height = container.clientHeight;
        };
        window.addEventListener('resize', resizeCanvas);
        // Initial call to set size on load
        window.addEventListener('load', () => {
            resizeCanvas();
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const aspectRatio = img.width / img.height;
                    const containerWidth = editorCanvas.parentElement.clientWidth;
                    let newWidth = containerWidth;
                    let newHeight = newWidth / aspectRatio;
                    
                    editorCanvas.width = newWidth;
                    editorCanvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        const getMousePos = (canvas, evt) => {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (evt.clientX - rect.left) / (rect.right - rect.left) * canvas.width,
                y: (evt.clientY - rect.top) / (rect.bottom - rect.top) * canvas.height
            };
        };

        const draw = (e) => {
            if (!isDrawing) return;
            const { x, y } = getMousePos(editorCanvas, e);
            
            ctx.beginPath();
            if (currentTool === 'erase') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = 'rgba(0,0,0,1)';
                ctx.lineWidth = 20;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = '#6b46c1';
                ctx.lineWidth = 5;
            }
            
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.stroke();
            [lastX, lastY] = [x, y];
        };

        editorCanvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            [lastX, lastY] = [getMousePos(editorCanvas, e).x, getMousePos(editorCanvas, e).y];
        });
        editorCanvas.addEventListener('mousemove', draw);
        editorCanvas.addEventListener('mouseup', () => isDrawing = false);
        editorCanvas.addEventListener('mouseout', () => isDrawing = false);

        // Touch events
        editorCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isDrawing = true;
            const touch = e.touches[0];
            const { x, y } = getMousePos(editorCanvas, touch);
            [lastX, lastY] = [x, y];
        });
        editorCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            draw(touch);
        });
        editorCanvas.addEventListener('touchend', () => isDrawing = false);

        clearCanvasBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);
        });

        paintToolBtn.addEventListener('click', () => {
            currentTool = 'paint';
            paintToolBtn.classList.add('bg-purple-600', 'text-white');
            paintToolBtn.classList.remove('bg-gray-500', 'text-white');
            eraseToolBtn.classList.remove('bg-purple-600', 'text-white');
            eraseToolBtn.classList.add('bg-gray-500', 'text-white');
        });

        eraseToolBtn.addEventListener('click', () => {
            currentTool = 'erase';
            eraseToolBtn.classList.add('bg-purple-600', 'text-white');
            eraseToolBtn.classList.remove('bg-gray-500', 'text-white');
            paintToolBtn.classList.remove('bg-purple-600', 'text-white');
            paintToolBtn.classList.add('bg-gray-500', 'text-white');
        });
    </script>
</body>
</html>
