<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doodle Art AI</title>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the doodle canvas */
        #doodle-canvas {
            touch-action: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            width: 100%;
            height: 100%;
        }

        /* Styles for the image upload container */
        #image-container {
            position: relative;
            width: 100%;
            height: auto;
            max-height: 90vh;
            border-radius: 12px;
        }
        #uploadedImageDisplay {
            width: 100%;
            height: auto;
            border-radius: 12px;
        }
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            border-radius: 12px;
        }
        /* Custom styles for the color picker */
        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 32px;
            height: 32px;
            background-color: transparent;
            border: none;
        }
        #colorPicker::-webkit-color-swatch {
            border-radius: 50%;
            border: 2px solid #ddd;
        }
        #colorPicker::-moz-color-swatch {
            border-radius: 50%;
            border: 2px solid #ddd;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white p-6 md:p-8 rounded-2xl shadow-xl flex flex-col md:flex-row gap-6 md:gap-8 relative">

        <!-- User Status and Generations Counter -->
        <div id="user-status" class="absolute top-4 right-4 bg-gray-100 px-4 py-2 rounded-lg text-sm text-gray-600 font-semibold shadow flex items-center gap-2">
            <span id="generationsLeft">...</span>
            <button id="authBtn" class="py-1 px-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300">Start Free Trial</button>
            <button id="logOutBtn" class="py-1 px-3 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 hidden">Log Out</button>
        </div>

        <!-- Mode-specific Content Container -->
        <div class="md:w-1/2 flex flex-col items-center">

            <!-- New Header Container for title and buttons -->
            <div class="w-full flex flex-col items-center mb-6">
                <!-- Title -->
                <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">Doodle Art AI</h1>
                <!-- Mode Switcher Buttons (now below the title) -->
                <div class="flex gap-2 justify-center mb-4">
                    <button id="doodleModeBtn" class="py-1 px-3 rounded-md transition duration-300 font-semibold bg-blue-500 text-white hover:bg-blue-600">Doodle Mode</button>
                    <button id="uploadModeBtn" class="py-1 px-3 rounded-md transition duration-300 font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Upload Image</button>
                </div>
                <!-- Dynamic text based on mode -->
                <p id="modeDescription" class="text-gray-500 text-center">Sketch your idea below, then describe it to create AI art!</p>
            </div>

            <!-- Doodle Mode Container -->
            <div id="doodle-mode" class="w-full h-full flex flex-col items-center">
                <div class="w-full h-full flex items-center justify-center mb-2">
                    <canvas id="doodle-canvas" class="border-2 border-gray-300"></canvas>
                </div>
                <p id="doodleInstruction" class="text-sm text-gray-500 mb-4 text-center">Use the doodle pad for a base sketch, or leave it blank to generate an image from your prompt alone.</p>
            </div>

            <!-- Upload Mode Container (Initially hidden) -->
            <div id="upload-mode" class="hidden w-full flex flex-col items-center">
                <div class="w-full flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-6 mb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Upload your image to get started</h3>
                    <input type="file" id="imageInput" accept="image/*" class="mb-4">
                </div>
                <div id="image-container" class="relative hidden w-full overflow-hidden">
                    <img id="uploadedImageDisplay" class="rounded-lg shadow-md border border-gray-200" src="" alt="Uploaded Image Preview">
                    <canvas id="drawing-canvas" class="absolute top-0 left-0"></canvas>
                </div>
                <p id="uploadInstruction" class="text-sm text-gray-500 mt-2 mb-4 text-center hidden">Draw on your uploaded image to guide the AI's transformation.</p>
            </div>
            
            <!-- Doodle Tools and Controls -->
            <div class="flex flex-col items-center justify-between gap-4 w-full p-4 bg-gray-50 rounded-lg shadow-inner mt-6">
                <!-- Tool Buttons (Horizontal Row) -->
                <div class="flex flex-wrap items-center justify-center gap-2">
                    <button id="brushBtn" class="tool-btn flex items-center gap-2 py-2 px-4 rounded-lg shadow-md transition duration-300 bg-blue-500 text-white font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M15.42 20.25a2.5 2.5 0 0 1-3.53 0L3.54 11.85a.75.75 0 0 1 0-1.06L10.96 3.37a.75.75 0 0 1 1.06 0l8.35 8.35a2.5 2.5 0 0 1 0 3.53l-6.24 6.24Z"/></svg>
                        <span>Brush</span>
                    </button>
                    <button id="pencilBtn" class="tool-btn flex items-center gap-2 py-2 px-4 rounded-lg shadow-md transition duration-300 bg-gray-200 text-gray-700 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M20.25 6.42L17.58 3.75a2.25 2.25 0 0 0-3.18 0l-9.84 9.84a.75.75 0 0 0-.21.53v3.18a.75.75 0 0 0 .75.75h3.18a.75.75 0 0 0 .53-.21l9.84-9.84a2.25 2.25 0 0 0 0-3.18Z"/></svg>
                        <span>Pencil</span>
                    </button>
                    <button id="fillBtn" class="tool-btn flex items-center gap-2 py-2 px-4 rounded-lg shadow-md transition duration-300 bg-gray-200 text-gray-700 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3.25 21.75a.75.75 0 0 0-.75.75c0 .41.34.75.75.75h18c.41 0 .75-.34.75-.75a.75.75 0 0 0-.75-.75h-18ZM18 1.5H6a4.5 4.5 0 0 0-4.5 4.5c0 1.2.66 2.26 1.65 2.84l4.63 2.68a.75.75 0 0 0 .33.09h1.37v.75a.75.75 0 0 0 1.5 0v-.75h4.12l.06.01a.75.75 0 0 0 .62-.71l.01-.16a1.5 1.5 0 0 0-.75-1.3l-4.5-2.6a1.5 1.5 0 0 1-.72-1.3V6a1.5 1.5 0 0 1 1.5-1.5h1.5a.75.75 0 0 0 0-1.5h-1.5A3 3 0 0 0 6 6v.75a.75.75 0 0 0 1.5 0v-.75a1.5 1.5 0 0 1 1.5-1.5h1.5a.75.75 0 0 0 0-1.5H9a3 3 0 0 0-3-3V2.25a.75.75 0 0 0 1.5 0V9a1.5 1.5 0 0 1 1.5-1.5h1.5A.75.75 0 0 0 9 6a3 3 0 0 0-3-3Z"/></svg>
                        <span>Fill</span>
                    </button>
                    <button id="eraserBtn" class="tool-btn flex items-center gap-2 py-2 px-4 rounded-lg shadow-md transition duration-300 bg-gray-200 text-gray-700 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M21 2.25a.75.75 0 0 0-1.06 0l-10.4 10.4a.75.75 0 0 0 0 1.06l1.24 1.24a.75.75 0 0 0 1.06 0l10.4-10.4a.75.75 0 0 0 0-1.06Zm-16.73 14.89-.96-.96c-.45-.45-.45-1.18 0-1.63L9.62 9.62c.45-.45 1.18-.45 1.63 0l.96.96c.45.45.45 1.18 0 1.63L5.87 17.14a1.15 1.15 0 0 1-1.63 0ZM1.5 21a.75.75 0 0 0 0 1.5h1.5A.75.75 0 0 0 3.75 22.5a.75.75 0 0 0-.75-.75h-1.5Z"/></svg>
                        <span>Eraser</span>
                    </button>
                </div>

                <!-- Drawing Properties (Size, Color, Clear) -->
                <div class="flex flex-col md:flex-row items-center justify-center gap-4 mt-4 md:mt-0">
                    <!-- Brush Size Slider -->
                    <div class="flex items-center gap-2">
                        <label for="brushSize" class="text-gray-700 font-semibold text-sm">Size:</label>
                        <input type="range" id="brushSize" min="1" max="50" value="4" class="w-24">
                        <span id="brushSizeValue" class="text-sm text-gray-500">4</span>
                        <!-- Visual brush size preview -->
                        <div id="brushSizePreview" class="rounded-full border border-gray-400" style="width: 4px; height: 4px; background-color: #000000;"></div>
                    </div>
                    <!-- Color Picker and Clear Button -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label for="colorPicker" class="text-gray-700 font-semibold text-sm">Color:</label>
                            <input type="color" id="colorPicker" value="#000000" class="w-8 h-8 rounded-full border-2 border-gray-300 cursor-pointer">
                        </div>
                        <button id="clearBtn" class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Generation Area -->
        <div class="md:w-1/2 flex flex-col items-center">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Generate Art</h2>
            
            <!-- Prompt Input -->
            <textarea id="promptInput" rows="3" placeholder="Describe the desired art style, e.g., 'a vibrant oil painting of a futuristic city'"
                class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300"></textarea>

            <!-- Generation Button & Loading Indicator -->
            <div class="w-full">
                <button id="generateBtn" class="w-full py-3 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300">
                    Generate AI Art
                </button>
                <div id="loadingIndicator" class="hidden text-center mt-2 text-gray-500">
                    Generating...
                </div>
            </div>

            <!-- Image Output Area and Download Button -->
            <div class="mt-6 w-full h-auto bg-gray-200 rounded-lg overflow-hidden flex flex-col items-center justify-center p-4 min-h-[300px]">
                <img id="generatedImage" src="https://placehold.co/512x512/E5E7EB/A1A1AA?text=Your+AI+Art+Here" alt="Generated AI Art" class="w-full h-auto object-contain rounded-md shadow-md mb-4">
                <button id="downloadBtn" class="w-full py-2 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 hidden">
                    Download Image
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modal Overlay -->
    <div id="authModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full relative">
            <button id="closeModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">&times;</button>
            <div id="modalContent">
                <!-- Content will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="termsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-2xl w-full relative h-full md:h-3/4 overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold">Terms of Service</h2>
                <button id="closeTermsBtn" class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
            </div>
            <div class="mt-4 text-gray-700 flex-grow overflow-y-auto">
                <p class="mb-4">Last Updated: October 26, 2023</p>
                
                <h3 class="font-bold text-lg mb-2">1. Introduction</h3>
                <p class="mb-4">Welcome to Doodle Art AI! These Terms of Service ("Terms") govern your access to and use of the Doodle Art AI website, products, and services ("Services"). By accessing or using our Services, you agree to be bound by these Terms and our Privacy Policy. If you do not agree to these Terms, you may not access or use our Services.</p>

                <h3 class="font-bold text-lg mb-2">2. Acceptance of Terms</h3>
                <p class="mb-4">By using our Services, you confirm that you are of legal age to form a binding contract with Doodle Art AI and are not barred from using the Services under the laws of your jurisdiction.</p>

                <h3 class="font-bold text-lg mb-2">3. Changes to Terms</h3>
                <p class="mb-4">We reserve the right to modify or replace these Terms at any time, at our sole discretion. We will provide notice of material changes, such as by posting a new version on our website. Your continued use of the Services after any changes constitutes your acceptance of the new Terms.</p>

                <h3 class="font-bold text-lg mb-2">4. User Responsibilities</h3>
                <p class="mb-4">You agree to use the Services only for lawful purposes and in a way that does not infringe the rights of, restrict, or inhibit anyone else's use and enjoyment of the Services. You are responsible for all activity that occurs under your account.</p>

                <h3 class="font-bold text-lg mb-2">5. Intellectual Property</h3>
                <p class="mb-4">All content on the Services, including but not limited to text, graphics, logos, images, and software, is the property of Doodle Art AI or its content suppliers and is protected by copyright and intellectual property laws. You may not use, reproduce, or distribute any content without our express written permission.</p>

                <h3 class="font-bold text-lg mb-2">6. Disclaimer of Warranties</h3>
                <p class="mb-4">The Services are provided on an "as is" and "as available" basis. Doodle Art AI makes no warranties, either express or implied, regarding the Services, including but not limited to the implied warranties of merchantability, fitness for a particular purpose, and non-infringement.</p>

                <h3 class="font-bold text-lg mb-2">7. Limitation of Liability</h3>
                <p class="mb-4">To the maximum extent permitted by law, Doodle Art AI shall not be liable for any indirect, incidental, special, consequential, or punitive damages, including loss of profits, data, or goodwill, arising from your use of or inability to use the Services.</p>

                <h3 class="font-bold text-lg mb-2">8. Governing Law</h3>
                <p class="mb-4">These Terms shall be governed by and construed in accordance with the laws of the state of Delaware without regard to its conflict of law provisions.</p>

                <h3 class="font-bold text-lg mb-2">9. Contact Us</h3>
                <p class="mb-4">If you have any questions about these Terms, please contact us at info@doodleartai.com.</p>
            </div>
        </div>
    </div>
    
    <!-- Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full relative text-center">
            <p id="messageText" class="text-lg text-gray-800 mb-4"></p>
            <button id="closeMessageBoxBtn" class="w-full py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-300">
                OK
            </button>
        </div>
    </div>
    
    <!-- Toast Message for no generations left -->
    <div id="toastMessage" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-lg z-40">
        You've used all your generations. Please register to continue!
    </div>
    
    <!-- Disclaimer Footer -->
    <footer class="mt-12 w-full max-w-4xl px-4 text-center text-sm text-gray-500 leading-relaxed">
        <p>
            Disclaimer: All images generated on this website are created using an AI model. The results are not guaranteed to be accurate, and the content is provided 'as is' without warranty. By using this tool, you agree to take full responsibility for the prompts you provide and the resulting images you generate. This is not legal advice. For more details, please see our <a href="#" id="termsLink" class="text-blue-500 underline hover:text-blue-700 transition-colors">Terms of Service</a>.
        </p>
    </footer>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for Firestore to see debug info in the console
        setLogLevel('debug');

        // --- Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let userStatus = {
            id: null,
            username: null,
            subscription: {
                plan: 'none', // 'none', 'trial', 'monthly', 'yearly'
                trialEndDate: null
            },
            generations: 10
        };

        let currentMode = 'doodle';
        let currentTool = 'brush';
        let brushSize = 4;
        let originalColor = '#000000';

        // --- UI Elements ---
        const doodleCanvas = document.getElementById('doodle-canvas');
        const doodleCtx = doodleCanvas.getContext('2d');
        const clearBtn = document.getElementById('clearBtn');
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const generatedImage = document.getElementById('generatedImage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generationsLeftDisplay = document.getElementById('generationsLeft');
        const authBtn = document.getElementById('authBtn');
        const logOutBtn = document.getElementById('logOutBtn');
        const authModal = document.getElementById('authModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalContent = document.getElementById('modalContent');
        const toastMessage = document.getElementById('toastMessage');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBoxBtn = document.getElementById('closeMessageBoxBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const termsLink = document.getElementById('termsLink');
        const termsModal = document.getElementById('termsModal');
        const closeTermsBtn = document.getElementById('closeTermsBtn');

        const doodleModeBtn = document.getElementById('doodleModeBtn');
        const uploadModeBtn = document.getElementById('uploadModeBtn');
        const doodleModeContainer = document.getElementById('doodle-mode');
        const uploadModeContainer = document.getElementById('upload-mode');
        const uploadedImageDisplay = document.getElementById('uploadedImageDisplay');
        const imageInput = document.getElementById('imageInput');
        const modeDescription = document.getElementById('modeDescription');
        const imageContainer = document.getElementById('image-container');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const drawingCtx = drawingCanvas.getContext('2d');
        const baseImageCanvas = document.createElement('canvas');
        const baseImageCtx = baseImageCanvas.getContext('2d');
        const doodleInstruction = document.getElementById('doodleInstruction');
        const uploadInstruction = document.getElementById('uploadInstruction');

        const toolBtns = document.querySelectorAll('.tool-btn');
        const brushBtn = document.getElementById('brushBtn');
        const pencilBtn = document.getElementById('pencilBtn');
        const fillBtn = document.getElementById('fillBtn');
        const eraserBtn = document.getElementById('eraserBtn');
        const brushSizeSlider = document.getElementById('brushSize');
        const brushSizeValueSpan = document.getElementById('brushSizeValue');
        const brushSizePreview = document.getElementById('brushSizePreview');
        const colorPicker = document.getElementById('colorPicker');

        // --- AUTHENTICATION & USER STATUS ---
        const loadUserStatus = async (uid) => {
            const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}/status/user_data`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    userStatus = docSnap.data();
                    userStatus.id = uid;
                } else {
                    userStatus = {
                        id: uid,
                        username: null,
                        subscription: { plan: 'none', trialEndDate: null },
                        generations: 10
                    };
                    await setDoc(userDocRef, userStatus);
                }
            } catch (error) {
                console.error("Error loading user status:", error);
            }
            updateUI();
        };

        const updateUserStatus = async (uid, data) => {
            const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}/status/user_data`);
            try {
                await updateDoc(userDocRef, data);
                userStatus = { ...userStatus, ...data };
                updateUI();
            } catch (error) {
                console.error("Error updating user status:", error);
            }
        };

        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                if (auth.currentUser) {
                    await loadUserStatus(auth.currentUser.uid);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }
        signIn();

        const updateUI = () => {
            const today = new Date();
            const trialEnd = userStatus.subscription.trialEndDate ? new Date(userStatus.subscription.trialEndDate) : null;
            const isTrialActive = userStatus.subscription.plan === 'trial' && trialEnd && today <= trialEnd;
            
            if (userStatus.subscription.plan === 'monthly' || userStatus.subscription.plan === 'yearly') {
                generationsLeftDisplay.textContent = `${userStatus.username}: Unlimited Generations`;
                authBtn.classList.add('hidden');
                logOutBtn.classList.remove('hidden');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate AI Art';
            } else if (isTrialActive) {
                const daysLeft = Math.ceil((trialEnd - today) / (1000 * 60 * 60 * 24));
                generationsLeftDisplay.textContent = `Free Trial: ${daysLeft} Days Left`;
                authBtn.classList.add('hidden');
                logOutBtn.classList.remove('hidden');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate AI Art';
            } else { // Guest or expired trial
                if (userStatus.username) { // Expired trial
                    generationsLeftDisplay.textContent = `${userStatus.username}: Trial Expired`;
                    authBtn.classList.remove('hidden');
                    logOutBtn.classList.remove('hidden');
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'Please Subscribe';
                } else { // Guest
                    generationsLeftDisplay.textContent = `Guest Mode: ${userStatus.generations} Generations Left`;
                    authBtn.classList.remove('hidden');
                    logOutBtn.classList.add('hidden');
                    if (userStatus.generations <= 0) {
                        generateBtn.disabled = true;
                        generateBtn.textContent = 'Start Free Trial';
                    } else {
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'Generate AI Art';
                    }
                }
            }
        };

        // --- Modal Content Management ---
        const renderGuestModal = () => {
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center">Start Your Free Trial</h2>
                <p class="text-gray-600 text-center mb-6">Enter a username to get a 7-day free trial with unlimited generations. No credit card required!</p>
                <input type="text" id="usernameInput" placeholder="Enter a username"
                    class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                <button id="startTrialBtn" class="w-full py-3 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300">
                    Start Free Trial
                </button>
                <div id="modalMessage" class="hidden mt-4 text-center text-sm font-medium"></div>
            `;
            document.getElementById('startTrialBtn').addEventListener('click', startFreeTrial);
        };
        
        const renderSubscriptionModal = () => {
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center">Upgrade to Premium</h2>
                <p class="text-gray-600 text-center mb-6">Unlock unlimited generations with a premium subscription.</p>
                <div class="flex flex-col gap-4">
                    <div id="monthlyPlan" class="plan-card border-2 border-blue-500 rounded-lg p-4 cursor-pointer hover:shadow-lg transition duration-300">
                        <h3 class="font-bold text-lg">Monthly Plan</h3>
                        <p class="text-gray-500">$9.99 / month</p>
                    </div>
                    <div id="yearlyPlan" class="plan-card border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-lg transition duration-300">
                        <h3 class="font-bold text-lg">Yearly Plan</h3>
                        <p class="text-gray-500">$89.99 / year</p>
                    </div>
                </div>
                <button id="subscribeBtn" class="w-full py-3 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 mt-6">
                    Subscribe
                </button>
                <div id="modalMessage" class="hidden mt-4 text-center text-sm font-medium"></div>
            `;
            
            const monthlyPlan = document.getElementById('monthlyPlan');
            const yearlyPlan = document.getElementById('yearlyPlan');
            let selectedPlan = 'monthly';

            monthlyPlan.classList.add('border-blue-500');
            yearlyPlan.classList.remove('border-blue-500');
            
            monthlyPlan.addEventListener('click', () => {
                selectedPlan = 'monthly';
                monthlyPlan.classList.add('border-blue-500');
                yearlyPlan.classList.remove('border-blue-500');
            });
            yearlyPlan.addEventListener('click', () => {
                selectedPlan = 'yearly';
                yearlyPlan.classList.add('border-blue-500');
                monthlyPlan.classList.remove('border-blue-500');
            });

            document.getElementById('subscribeBtn').addEventListener('click', async () => {
                await subscribe(selectedPlan);
            });
        };

        const startFreeTrial = async () => {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            const modalMessage = document.getElementById('modalMessage');
            if (username.length < 3) {
                modalMessage.textContent = "Username must be at least 3 characters long.";
                modalMessage.classList.remove('hidden');
                modalMessage.classList.add('text-red-500');
                return;
            }
            try {
                const trialEndDate = new Date();
                trialEndDate.setDate(trialEndDate.getDate() + 7);
                await updateUserStatus(userStatus.id, {
                    username: username,
                    subscription: { plan: 'trial', trialEndDate: trialEndDate.toISOString() }
                });
                authModal.classList.add('hidden');
                authModal.classList.remove('flex');
                showMessageBox(`Welcome, ${username}! Your free 7-day trial has begun.`);
            } catch (error) {
                modalMessage.textContent = "Registration failed. Please try again.";
                modalMessage.classList.remove('hidden');
                modalMessage.classList.add('text-red-500');
            }
        };

        const subscribe = async (plan) => {
            const modalMessage = document.getElementById('modalMessage');
            try {
                // Simulate payment and subscription update
                await updateUserStatus(userStatus.id, {
                    subscription: { plan: plan }
                });
                authModal.classList.add('hidden');
                authModal.classList.remove('flex');
                showMessageBox(`You are now on the ${plan} plan! Enjoy unlimited generations.`);
            } catch (error) {
                modalMessage.textContent = "Subscription failed. Please try again.";
                modalMessage.classList.remove('hidden');
                modalMessage.classList.add('text-red-500');
            }
        };

        authBtn.addEventListener('click', () => {
            const today = new Date();
            const trialEnd = userStatus.subscription.trialEndDate ? new Date(userStatus.subscription.trialEndDate) : null;
            const isTrialExpired = userStatus.subscription.plan === 'trial' && today > trialEnd;

            if (userStatus.subscription.plan === 'none' || isTrialExpired) {
                renderGuestModal();
            } else {
                renderSubscriptionModal();
            }
            authModal.classList.remove('hidden');
            authModal.classList.add('flex');
        });

        logOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Clear local state and reset to guest
                userStatus = {
                    id: crypto.randomUUID(), // New anonymous ID
                    username: null,
                    subscription: { plan: 'none', trialEndDate: null },
                    generations: 10
                };
                await setDoc(doc(db, `/artifacts/${appId}/users/${userStatus.id}/status/user_data`), userStatus);
                updateUI();
                showMessageBox("You have been logged out. You are now in Guest Mode.");
            } catch (error) {
                console.error("Logout failed:", error);
                showMessageBox("Logout failed. Please try again.");
            }
        });

        closeModalBtn.addEventListener('click', () => {
            authModal.classList.add('hidden');
            authModal.classList.remove('flex');
        });

        // --- Mode Switching Logic ---
        const switchMode = (mode) => {
            currentMode = mode;
            if (mode === 'doodle') {
                doodleModeContainer.classList.remove('hidden');
                uploadModeContainer.classList.add('hidden');
                doodleModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                doodleModeBtn.classList.add('bg-blue-500', 'text-white');
                uploadModeBtn.classList.remove('bg-blue-500', 'text-white');
                uploadModeBtn.classList.add('bg-gray-200', 'text-gray-700');
                modeDescription.textContent = "Sketch your idea below, then describe it to create AI art!";
                promptInput.placeholder = "Describe your doodle here, e.g., 'a playful cat with a ball of yarn, digital painting'";
                doodleInstruction.classList.remove('hidden');
                uploadInstruction.classList.add('hidden');
                clearBtn.textContent = 'Clear Doodle';
            } else {
                doodleModeContainer.classList.add('hidden');
                uploadModeContainer.classList.remove('hidden');
                doodleModeBtn.classList.remove('bg-blue-500', 'text-white');
                doodleModeBtn.classList.add('bg-gray-200', 'text-gray-700');
                uploadModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                uploadModeBtn.classList.add('bg-gray-200', 'text-gray-700');
                modeDescription.textContent = "Draw on your uploaded image to edit it, then describe how you want to transform it!";
                promptInput.placeholder = "Describe how you want to transform the image, e.g., 'a photo of a city transformed into a watercolor painting'";
                doodleInstruction.classList.add('hidden');
                uploadInstruction.classList.remove('hidden');
                clearBtn.textContent = 'Clear Drawing';
            }
        };

        doodleModeBtn.addEventListener('click', () => switchMode('doodle'));
        uploadModeBtn.addEventListener('click', () => switchMode('upload'));

        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImageDisplay.src = e.target.result;
                        imageContainer.classList.remove('hidden');
                        drawingCanvas.width = img.width;
                        drawingCanvas.height = img.height;
                        baseImageCanvas.width = img.width;
                        baseImageCanvas.height = img.height;
                        baseImageCtx.drawImage(img, 0, 0);
                        
                        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Tool Logic ---
        const setActiveTool = (tool) => {
            currentTool = tool;
            toolBtns.forEach(btn => btn.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600'));
            toolBtns.forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300'));

            if (tool === 'brush') {
                brushBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                brushBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                brushSizeSlider.value = brushSize;
                colorPicker.disabled = false;
                colorPicker.value = originalColor;
            } else if (tool === 'pencil') {
                pencilBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                pencilBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                brushSizeSlider.value = 1;
                colorPicker.disabled = false;
                colorPicker.value = originalColor;
            } else if (tool === 'fill') {
                fillBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                fillBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                colorPicker.disabled = false;
                colorPicker.value = originalColor;
            } else if (tool === 'eraser') {
                eraserBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                eraserBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                colorPicker.disabled = true;
            }
        };

        toolBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveTool(btn.id.replace('Btn', ''));
            });
        });

        const updateBrushPreview = (size, color) => {
            brushSizePreview.style.width = `${size}px`;
            brushSizePreview.style.height = `${size}px`;
            brushSizePreview.style.backgroundColor = color;
        };

        brushSizeSlider.addEventListener('input', (e) => {
            brushSize = e.target.value;
            brushSizeValueSpan.textContent = brushSize;
            updateBrushPreview(brushSize, colorPicker.value);
            setActiveTool('brush');
        });

        colorPicker.addEventListener('input', (e) => {
            originalColor = e.target.value;
            updateBrushPreview(brushSize, originalColor);
        });

        // --- Canvas Drawing Logic ---
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function resizeDoodleCanvas() {
            const container = doodleCanvas.parentElement;
            doodleCanvas.width = container.clientWidth;
            doodleCanvas.height = container.clientHeight;
            doodleCtx.fillStyle = '#ffffff';
            doodleCtx.fillRect(0, 0, doodleCanvas.width, doodleCanvas.height);
        }

        window.addEventListener('resize', resizeDoodleCanvas);
        resizeDoodleCanvas();
        setActiveTool('brush');
        updateBrushPreview(brushSize, originalColor);

        function draw(e, canvas, ctx) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.type.includes('mouse') ? e.offsetX : e.touches[0].clientX - rect.left;
            const y = e.type.includes('mouse') ? e.offsetY : e.touches[0].clientY - rect.top;
            
            ctx.strokeStyle = (currentTool === 'eraser') ? '#FFFFFF' : colorPicker.value;
            ctx.lineWidth = (currentTool === 'pencil') ? 1 : brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            [lastX, lastY] = [x, y];
        }

        const floodFill = (canvas, ctx, x, y, fillColor) => {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const targetColor = getPixelColor(data, x, y, canvas.width);
            const fillR = parseInt(fillColor.slice(1, 3), 16);
            const fillG = parseInt(fillColor.slice(3, 5), 16);
            const fillB = parseInt(fillColor.slice(5, 7), 16);

            if (targetColor[0] === fillR && targetColor[1] === fillG && targetColor[2] === fillB) {
                return;
            }

            const pixelStack = [[x, y]];
            let pixel;

            while (pixelStack.length) {
                pixel = pixel.pop();
                let newX = pixel[0];
                let newY = pixel[1];

                let pixelPos = (newY * canvas.width + newX) * 4;

                while (newY >= 0 && colorsMatch(data, pixelPos, targetColor)) {
                    newY--;
                    pixelPos -= canvas.width * 4;
                }
                pixelPos += canvas.width * 4;
                newY++;

                let reachLeft = false;
                let reachRight = false;

                while (newY < canvas.height && colorsMatch(data, pixelPos, targetColor)) {
                    colorPixel(data, pixelPos, [fillR, fillG, fillB]);
                    
                    if (newX > 0) {
                        if (colorsMatch(data, pixelPos - 4, targetColor)) {
                            if (!reachLeft) {
                                pixelStack.push([newX - 1, newY]);
                                reachLeft = true;
                            }
                        } else if (reachLeft) {
                            reachLeft = false;
                        }
                    }

                    if (newX < canvas.width - 1) {
                        if (colorsMatch(data, pixelPos + 4, targetColor)) {
                            if (!reachRight) {
                                pixelStack.push([newX + 1, newY]);
                                reachRight = true;
                            }
                        } else if (reachRight) {
                            reachRight = false;
                        }
                    }

                    newY++;
                    pixelPos += canvas.width * 4;
                }
            }
            ctx.putImageData(imageData, 0, 0);
        };

        const getPixelColor = (data, x, y, width) => {
            const index = (y * width + x) * 4;
            return [data[index], data[index + 1], data[index + 2]];
        };

        const colorsMatch = (data, index, color) => {
            return data[index] === color[0] && data[index + 1] === color[1] && data[index + 2] === color[2];
        };

        const colorPixel = (data, index, color) => {
            data[index] = color[0];
            data[index + 1] = color[1];
            data[index + 2] = color[2];
            data[index + 3] = 255;
        };


        const setupDrawingEvents = (canvas, ctx) => {
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.offsetX;
                const y = e.offsetY;

                if (currentTool === 'fill') {
                    floodFill(canvas, ctx, x, y, colorPicker.value);
                } else {
                    isDrawing = true;
                    [lastX, lastY] = [x, y];
                }
            });
            canvas.addEventListener('mousemove', (e) => {
                if (currentTool !== 'fill') {
                    draw(e, canvas, ctx);
                }
            });
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = e.touches[0].clientX - rect.left;
                const y = e.touches[0].clientY - rect.top;

                if (currentTool === 'fill') {
                    floodFill(canvas, ctx, x, y, colorPicker.value);
                } else {
                    isDrawing = true;
                    [lastX, lastY] = [x, y];
                }
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (currentTool !== 'fill') {
                    draw(e, canvas, ctx);
                }
            });
            canvas.addEventListener('touchend', () => isDrawing = false);
        };
        
        setupDrawingEvents(doodleCanvas, doodleCtx);
        setupDrawingEvents(drawingCanvas, drawingCtx);
        
        const showMessageBox = (message) => {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        };

        const showToast = (message) => {
            toastMessage.textContent = message;
            toastMessage.classList.remove('hidden');
            setTimeout(() => {
                toastMessage.classList.add('hidden');
            }, 3000);
        };
        
        const getCompositeImage = () => {
            const compositeCanvas = document.createElement('canvas');
            compositeCanvas.width = uploadedImageDisplay.naturalWidth;
            compositeCanvas.height = uploadedImageDisplay.naturalHeight;
            const compositeCtx = compositeCanvas.getContext('2d');
            
            compositeCtx.drawImage(uploadedImageDisplay, 0, 0);
            
            const ratioX = uploadedImageDisplay.naturalWidth / drawingCanvas.width;
            const ratioY = uploadedImageDisplay.naturalHeight / drawingCanvas.height;
            
            compositeCtx.drawImage(drawingCanvas, 0, 0, drawingCanvas.width * ratioX, drawingCanvas.height * ratioY);
            
            return compositeCanvas.toDataURL('image/png');
        };

        const generateImage = async (prompt, imageBase64) => {
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/png", data: imageBase64.replace(/^data:image\/(png|jpeg);base64,/, '') } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                },
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error("No image data found in API response.");
                }
                
                return `data:image/png;base64,${base64Data}`;

            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        };

        generateBtn.addEventListener('click', async () => {
            const today = new Date();
            const trialEnd = userStatus.subscription.trialEndDate ? new Date(userStatus.subscription.trialEndDate) : null;
            const isTrialActive = userStatus.subscription.plan === 'trial' && trialEnd && today <= trialEnd;
            const isGuest = userStatus.subscription.plan === 'none';
            const isPremium = userStatus.subscription.plan === 'monthly' || userStatus.subscription.plan === 'yearly';

            if (isGuest && userStatus.generations <= 0) {
                showToast("You have no generations left. Please start a free trial.");
                return;
            }
            if (!isGuest && !isTrialActive && !isPremium) {
                showToast("Your trial has expired. Please subscribe to continue.");
                return;
            }

            const prompt = promptInput.value.trim();
            if (!prompt) {
                showMessageBox("Please enter a text prompt to guide the AI generation.");
                return;
            }

            let sourceImageBase64 = null;
            if (currentMode === 'doodle') {
                sourceImageBase64 = doodleCanvas.toDataURL('image/png');
            } else {
                if (!uploadedImageDisplay.src || !drawingCanvas.width) {
                    showMessageBox("Please upload an image first.");
                    return;
                }
                sourceImageBase64 = getCompositeImage();
            }

            generatedImage.src = 'https://placehold.co/512x512/E5E7EB/A1A1AA?text=Generating+...';
            loadingIndicator.classList.remove('hidden');
            generateBtn.disabled = true;
            downloadBtn.classList.add('hidden');
            
            try {
                const generatedImageUrl = await generateImage(prompt, sourceImageBase64);
                generatedImage.src = generatedImageUrl;
                downloadBtn.classList.remove('hidden');
                
                if (isGuest) {
                    const newGenerations = userStatus.generations - 1;
                    await updateUserStatus(userStatus.id, { generations: newGenerations });
                }

            } catch (error) {
                console.error("Generation failed:", error);
                generatedImage.src = 'https://placehold.co/512x512/E5E7EB/A1A1AA?text=Generation+Failed';
                showMessageBox("Image generation failed. Please try again with a different prompt.");
            } finally {
                loadingIndicator.classList.add('hidden');
                generateBtn.disabled = false;
            }
        });

        clearBtn.addEventListener('click', () => {
            if (currentMode === 'doodle') {
                doodleCtx.clearRect(0, 0, doodleCanvas.width, doodleCanvas.height);
                doodleCtx.fillStyle = '#ffffff';
                doodleCtx.fillRect(0, 0, doodleCanvas.width, doodleCanvas.height);
            } else {
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            }
        });

        closeMessageBoxBtn.addEventListener('click', () => {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        });

        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = generatedImage.src;
            link.download = `doodle_art_ai_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Event listeners for the new Terms of Service modal
        termsLink.addEventListener('click', (e) => {
            e.preventDefault();
            termsModal.classList.remove('hidden');
            termsModal.classList.add('flex');
        });

        closeTermsBtn.addEventListener('click', () => {
            termsModal.classList.remove('flex');
            termsModal.classList.add('hidden');
        });

    </script>
</body>
</html>
